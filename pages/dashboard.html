<!-- ==================== DASHBOARD PAGE ==================== -->

<div class="dashboard-page">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>
            <p class="text-gray-600 mt-1">Welcome back, <span id="provider-name">Dr. Pompee</span></p>
        </div>
        <div class="text-right">
            <div class="text-sm text-gray-600">
                <span id="current-date"></span>
            </div>
            <div class="text-2xl font-bold text-sky-600">
                <span id="current-time"></span>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <!-- Today's Appointments -->
        <div class="card bg-gradient-to-br from-sky-500 to-sky-600 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sky-100 text-sm mb-1">Today's Appointments</p>
                    <p class="text-3xl font-bold" id="stat-appointments">12</p>
                </div>
                <div class="w-14 h-14 rounded-full bg-white/20 flex items-center justify-center">
                    <i class="ph ph-calendar-check text-3xl"></i>
                </div>
            </div>
        </div>

        <!-- Unread Messages -->
        <div class="card bg-gradient-to-br from-cyan-500 to-cyan-600 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-cyan-100 text-sm mb-1">Unread Messages</p>
                    <p class="text-3xl font-bold" id="stat-messages">3</p>
                </div>
                <div class="w-14 h-14 rounded-full bg-white/20 flex items-center justify-center">
                    <i class="ph ph-chat-dots text-3xl"></i>
                </div>
            </div>
        </div>

        <!-- Critical Alerts -->
        <div class="card bg-gradient-to-br from-red-500 to-red-600 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-red-100 text-sm mb-1">Critical Alerts</p>
                    <p class="text-3xl font-bold" id="stat-alerts">2</p>
                </div>
                <div class="w-14 h-14 rounded-full bg-white/20 flex items-center justify-center">
                    <i class="ph ph-warning text-3xl"></i>
                </div>
            </div>
        </div>

        <!-- Patients Seen Today -->
        <div class="card bg-gradient-to-br from-green-500 to-green-600 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-sm mb-1">Patients Seen</p>
                    <p class="text-3xl font-bold" id="stat-patients-seen">8</p>
                </div>
                <div class="w-14 h-14 rounded-full bg-white/20 flex items-center justify-center">
                    <i class="ph ph-users text-3xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Today's Schedule -->
        <div class="lg:col-span-2">
            <div class="card">
                <div class="card-header">
                    <i class="ph ph-calendar text-sky-600"></i>
                    Today's Schedule
                </div>
                <div id="todays-schedule" class="space-y-3">
                    <!-- Will be populated by JavaScript -->
                    <div class="flex items-center justify-center py-8 text-gray-400">
                        <div class="spinner mr-3"></div>
                        Loading schedule...
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions & Alerts -->
        <div class="space-y-6">
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <i class="ph ph-lightning text-yellow-600"></i>
                    Quick Actions
                </div>
                <div class="space-y-2">
                    <button class="w-full btn btn-primary justify-start" onclick="window.location.hash='patient-search'">
                        <i class="ph ph-magnifying-glass"></i>
                        Find Patient
                    </button>
                    <button class="w-full btn btn-secondary justify-start" onclick="window.location.hash='scheduling'">
                        <i class="ph ph-calendar-plus"></i>
                        New Appointment
                    </button>
                    <button class="w-full btn btn-secondary justify-start" onclick="window.location.hash='messages'">
                        <i class="ph ph-chat-dots"></i>
                        Messages
                    </button>
                </div>
            </div>

            <!-- Critical Alerts -->
            <div class="card border-l-4 border-red-500">
                <div class="card-header text-red-600">
                    <i class="ph ph-warning-circle"></i>
                    Critical Alerts
                </div>
                <div id="critical-alerts" class="space-y-3">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="mt-6">
        <div class="card">
            <div class="card-header">
                <i class="ph ph-clock-counter-clockwise text-sky-600"></i>
                Recent Activity
            </div>
            <div id="recent-activity" class="space-y-2">
                <!-- Will be populated by JavaScript -->
                <div class="flex items-center justify-center py-8 text-gray-400">
                    <div class="spinner mr-3"></div>
                    Loading activity...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize Dashboard
window.initDashboard = async function() {
    console.log('üìä Initializing Dashboard...');
    
    // Update date and time
    updateDateTime();
    setInterval(updateDateTime, 1000);
    
    // Load dashboard data
    await loadDashboardData();
};

function updateDateTime() {
    const now = new Date();
    
    // Update date
    const dateEl = document.getElementById('current-date');
    if (dateEl) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateEl.textContent = now.toLocaleDateString('en-US', options);
    }
    
    // Update time
    const timeEl = document.getElementById('current-time');
    if (timeEl) {
        timeEl.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }
}

async function loadDashboardData() {
    // Simulate loading delay
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Load today's schedule
    loadTodaysSchedule();
    
    // Load critical alerts
    loadCriticalAlerts();
    
    // Load recent activity
    loadRecentActivity();
    
    // Update stats
    updateStats();
}

function loadTodaysSchedule() {
    const container = document.getElementById('todays-schedule');
    if (!container) return;
    
    const appointments = [
        { time: '08:00 AM', patient: 'Jane Doe', type: 'Follow-up', status: 'completed' },
        { time: '08:30 AM', patient: 'John Smith', type: 'New Patient', status: 'completed' },
        { time: '09:00 AM', patient: 'Alice Johnson', type: 'Wound Care', status: 'completed' },
        { time: '09:30 AM', patient: 'Robert Brown', type: 'Follow-up', status: 'in-progress' },
        { time: '10:00 AM', patient: 'Mary Williams', type: 'Annual Physical', status: 'scheduled' },
        { time: '10:30 AM', patient: 'James Davis', type: 'Follow-up', status: 'scheduled' },
        { time: '11:00 AM', patient: 'Patricia Miller', type: 'Consultation', status: 'scheduled' },
        { time: '02:00 PM', patient: 'Michael Wilson', type: 'Follow-up', status: 'scheduled' }
    ];
    
    container.innerHTML = appointments.map(apt => `
        <div class="flex items-center gap-4 p-3 rounded-lg border ${
            apt.status === 'completed' ? 'bg-green-50 border-green-200' :
            apt.status === 'in-progress' ? 'bg-sky-50 border-sky-200' :
            'bg-gray-50 border-gray-200'
        }">
            <div class="text-center min-w-[80px]">
                <div class="text-sm font-semibold text-gray-700">${apt.time}</div>
            </div>
            <div class="flex-grow">
                <div class="font-semibold text-gray-800">${apt.patient}</div>
                <div class="text-sm text-gray-600">${apt.type}</div>
            </div>
            <div>
                <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                    apt.status === 'completed' ? 'bg-green-100 text-green-700' :
                    apt.status === 'in-progress' ? 'bg-sky-100 text-sky-700' :
                    'bg-gray-100 text-gray-700'
                }">
                    ${apt.status === 'completed' ? '‚úì Completed' :
                      apt.status === 'in-progress' ? '‚ü≥ In Progress' :
                      'Scheduled'}
                </span>
            </div>
        </div>
    `).join('');
}

async function loadCriticalAlerts() {
    const container = document.getElementById('critical-alerts');
    if (!container) {
        console.error('‚ùå Critical alerts container not found');
        return;
    }
    
    console.log('üîÑ Loading critical alerts...');
    
    try {
        // Import alerts from data file
        console.log('üì• Importing alerts data...');
        const { getAlertsByPriority, getUnreadAlerts } = await import('../data/alerts-messages.js');
        console.log('‚úÖ Alerts data imported successfully');
        
        // Get critical and high priority alerts
        const criticalAlerts = getAlertsByPriority('critical');
        const highAlerts = getAlertsByPriority('high').slice(0, 2); // Top 2 high alerts
        const alerts = [...criticalAlerts, ...highAlerts];
        
        console.log(`üìä Found ${alerts.length} alerts (${criticalAlerts.length} critical, ${highAlerts.length} high)`);
        
        // Update stat card
        const criticalCount = criticalAlerts.length;
        document.getElementById('stat-alerts').textContent = criticalCount;
        
        if (alerts.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No critical alerts</p>';
            return;
        }
        
        const priorityColors = {
            'critical': { bg: 'bg-red-50', border: 'border-red-200', icon: 'text-red-500', badge: 'bg-red-100 text-red-700' },
            'high': { bg: 'bg-orange-50', border: 'border-orange-200', icon: 'text-orange-500', badge: 'bg-orange-100 text-orange-700' }
        };
        
        container.innerHTML = alerts.map(alert => {
            const colors = priorityColors[alert.priority] || priorityColors['high'];
            const timeAgo = getTimeAgo(alert.date);
            
            return `
                <div class="p-3 ${colors.bg} border ${colors.border} rounded-lg cursor-pointer hover:shadow-md transition-shadow"
                     onclick="window.handleAlertClick('${alert.id}', '${alert.type}', '${alert.patientId || ''}')"
                     onclick="window.viewAlertDetails('${alert.id}')">
                    <div class="flex items-start gap-2">
                        <i class="ph ph-warning-circle ${colors.icon} text-xl mt-0.5"></i>
                        <div class="flex-grow">
                            <div class="flex items-center justify-between mb-1">
                                <div class="font-semibold text-gray-800">${alert.patient.name}</div>
                                <span class="px-2 py-0.5 text-xs rounded-full ${colors.badge} uppercase">
                                    ${alert.priority}
                                </span>
                            </div>
                            <div class="text-sm font-medium text-gray-800">${alert.title}</div>
                            <div class="text-xs text-gray-600 mt-1">${alert.message.substring(0, 80)}${alert.message.length > 80 ? '...' : ''}</div>
                            <div class="flex items-center justify-between mt-2">
                                <div class="text-xs text-gray-500">${timeAgo}</div>
                                ${alert.actionRequired ? '<div class="text-xs font-medium text-sky-600">‚ö° Action Required</div>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('‚ùå Error loading alerts:', error);
        console.error('Error details:', error.message, error.stack);
        container.innerHTML = `
            <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="text-sm text-gray-700">Unable to load alerts.</div>
                <div class="text-xs text-red-600 mt-1">Error: ${error.message}</div>
            </div>
        `;
    }
}

function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
}

window.viewAlertDetails = function(alertId) {
    // For now, just show a toast - full modal implementation coming
    import('../js/ui-components.js').then(({ showToast }) => {
        showToast(`Viewing details for alert ${alertId}`, 'info');
    });
};

function loadRecentActivity() {
    const container = document.getElementById('recent-activity');
    if (!container) return;
    
    const activities = [
        { icon: 'ph-note-pencil', color: 'text-sky-600', action: 'Visit note completed', patient: 'Robert Brown', time: '5 minutes ago', type: 'visit', patientId: '001' },
        { icon: 'ph-prescription', color: 'text-green-600', action: 'Prescription sent', patient: 'Alice Johnson', time: '15 minutes ago', type: 'prescription', patientId: '003' },
        { icon: 'ph-check-circle', color: 'text-green-600', action: 'Appointment completed', patient: 'John Smith', time: '1 hour ago', type: 'appointment', patientId: '001' },
        { icon: 'ph-chat-dots', color: 'text-cyan-600', action: 'Message received', patient: 'Jane Doe', time: '2 hours ago', type: 'message', patientId: '002', messageId: 'pm001' }
    ];
    
    container.innerHTML = activities.map(activity => `
        <div class="flex items-center gap-4 p-3 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer"
             onclick="window.handleActivityClick('${activity.type}', '${activity.messageId || ''}', '${activity.patientId || ''}')">
            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
                <i class="${activity.icon} ${activity.color} text-xl"></i>
            </div>
            <div class="flex-grow">
                <div class="text-sm font-semibold text-gray-800">${activity.action}</div>
                <div class="text-sm text-gray-600">${activity.patient}</div>
            </div>
            <div class="text-xs text-gray-500 whitespace-nowrap">
                ${activity.time}
            </div>
        </div>
    `).join('');
}

async function updateStats() {
    console.log('üìà Updating stats...');
    try {
        // Import from data files
        console.log('üì• Importing message data...');
        const { getUnreadMessages } = await import('../data/alerts-messages.js');
        console.log('‚úÖ Message data imported');
        
        // Get actual counts
        const unreadCount = getUnreadMessages().length;
        console.log(`üìä Found ${unreadCount} unread messages`);
        
        // Count today's appointments (would come from scheduling data)
        const today = new Date().toISOString().split('T')[0];
        // For now, hardcode as 3 (Jane, John, Alice scheduled for today)
        const todayAppointments = 3;
        
        // Update stat cards
        document.getElementById('stat-appointments').textContent = todayAppointments;
        document.getElementById('stat-messages').textContent = unreadCount;
        // stat-alerts updated in loadCriticalAlerts()
        document.getElementById('stat-patients-seen').textContent = '8'; // From daily activity tracking
        
        console.log('‚úÖ Stats updated successfully');
    } catch (error) {
        console.error('‚ùå Error updating stats:', error);
        console.error('Error details:', error.message);
        // Fallback to demo data
        document.getElementById('stat-appointments').textContent = '3';
        document.getElementById('stat-messages').textContent = '3';
        document.getElementById('stat-patients-seen').textContent = '8';
    }
}

// Handle alert click - navigate to relevant page
window.handleAlertClick = async function(alertId, alertType, patientId) {
    console.log('üîî Alert clicked:', alertId, alertType, patientId);
    
    if (patientId) {
        // Load patient data and navigate to chart
        const { patients } = await import('../data/patients.js');
        const patient = patients.find(p => p.id === patientId);
        
        if (patient) {
            window.appState.currentPatient = patient;
            localStorage.setItem('currentPatient', JSON.stringify(patient));
            
            // Navigate based on alert type
            if (alertType === 'lab' || alertType === 'test-result') {
                window.location.hash = 'patient-chart';
            } else if (alertType === 'appointment' || alertType === 'follow-up') {
                window.location.hash = 'scheduling';
            } else if (alertType === 'medication' || alertType === 'refill') {
                window.location.hash = 'patient-chart';
            } else {
                window.location.hash = 'patient-chart';
            }
        }
    }
};

// Handle message click
window.handleMessageClick = function(messageId) {
    console.log('üí¨ Message clicked:', messageId);
    sessionStorage.setItem('selectedMessageId', messageId);
    window.location.hash = 'messages';
};

// Handle activity click from recent activity feed
window.handleActivityClick = async function(type, messageId, patientId) {
    console.log('üìã Activity clicked:', type, messageId, patientId);
    
    if (type === 'message' && messageId) {
        sessionStorage.setItem('selectedMessageId', messageId);
        window.location.hash = 'messages';
    } else if (patientId) {
        const { patients } = await import('../data/patients.js');
        const patient = patients.find(p => p.id === patientId);
        
        if (patient) {
            window.appState.currentPatient = patient;
            localStorage.setItem('currentPatient', JSON.stringify(patient));
            
            if (type === 'lab') {
                window.location.hash = 'patient-chart';
            } else if (type === 'appointment') {
                window.location.hash = 'scheduling';
            } else {
                window.location.hash = 'patient-chart';
            }
        }
    }
};
</script>
