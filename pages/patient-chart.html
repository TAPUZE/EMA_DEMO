<!-- ==================== PATIENT CHART PAGE ==================== -->

<div class="p-6">
    <div id="no-patient-message" class="glass p-8 text-center">
        <i class="ph ph-user-circle text-6xl text-gray-400 mb-4"></i>
        <h2 class="text-xl font-bold text-gray-700 mb-2">No Patient Selected</h2>
        <p class="text-gray-600 mb-4">Please select a patient from the search page to view their chart.</p>
        <button onclick="window.location.hash='patient-search'" class="btn-primary">
            <i class="ph ph-magnifying-glass mr-2"></i>
            Search Patients
        </button>
    </div>

    <div id="patient-chart-content" class="hidden">
        <!-- Chart Header -->
        <div class="glass p-6 mb-6">
            <div class="flex items-start justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800" id="chart-patient-name"></h1>
                    <div class="flex gap-6 mt-2 text-sm text-gray-600">
                        <span><strong>MRN:</strong> <span id="chart-mrn"></span></span>
                        <span><strong>DOB:</strong> <span id="chart-dob"></span></span>
                        <span><strong>Age:</strong> <span id="chart-age"></span></span>
                        <span><strong>Gender:</strong> <span id="chart-gender"></span></span>
                    </div>
                    <div class="mt-2">
                        <span class="text-sm text-gray-600"><strong>Allergies:</strong></span>
                        <span id="chart-allergies" class="ml-2"></span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="btn-primary" onclick="window.location.hash='guided-visit'">
                        <i class="ph ph-clipboard-text mr-2"></i>
                        Guided Visit
                    </button>
                    <button class="btn-secondary" onclick="window.loadPage('visit-note')">
                        <i class="ph ph-note-pencil mr-2"></i>
                        Quick Note
                    </button>
                    <button class="btn-secondary" onclick="window.printChart()">
                        <i class="ph ph-printer mr-2"></i>
                        Print
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="glass mb-6">
            <div class="flex border-b border-gray-200 overflow-x-auto">
                <button class="tab-button active" data-tab="summary">
                    <i class="ph ph-list-dashes mr-2"></i>
                    Summary
                </button>
                <button class="tab-button" data-tab="problems">
                    <i class="ph ph-warning-circle mr-2"></i>
                    Problems
                </button>
                <button class="tab-button" data-tab="medications">
                    <i class="ph ph-pill mr-2"></i>
                    Medications
                </button>
                <button class="tab-button" data-tab="visits">
                    <i class="ph ph-clock-counter-clockwise mr-2"></i>
                    Visit History
                </button>
                <button class="tab-button" data-tab="vitals">
                    <i class="ph ph-heart-straight mr-2"></i>
                    Vitals
                </button>
                <button class="tab-button" data-tab="labs">
                    <i class="ph ph-flask mr-2"></i>
                    Labs
                </button>
                <button class="tab-button" data-tab="preventive">
                    <i class="ph ph-shield-check mr-2"></i>
                    Preventive
                </button>
                <button class="tab-button" data-tab="assessments">
                    <i class="ph ph-brain mr-2"></i>
                    Assessments
                </button>
                <button class="tab-button" data-tab="surgical">
                    <i class="ph ph-knife mr-2"></i>
                    Surgical Hx
                </button>
                <button class="tab-button" data-tab="family">
                    <i class="ph ph-users-three mr-2"></i>
                    Family Hx
                </button>
                <button class="tab-button" data-tab="social">
                    <i class="ph ph-house mr-2"></i>
                    Social Hx
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            <!-- Summary Tab -->
            <div class="tab-panel active" data-tab="summary">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Active Problems -->
                    <div class="glass p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="ph ph-warning-circle mr-2 text-red-500"></i>
                            Active Problems
                        </h3>
                        <div id="summary-problems" class="space-y-2"></div>
                    </div>

                    <!-- Current Medications -->
                    <div class="glass p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="ph ph-pill mr-2 text-sky-500"></i>
                            Current Medications
                        </h3>
                        <div id="summary-medications" class="space-y-2"></div>
                    </div>

                    <!-- Recent Vitals -->
                    <div class="glass p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="ph ph-heart-straight mr-2 text-red-500"></i>
                            Most Recent Vitals
                        </h3>
                        <div id="summary-vitals" class="space-y-2"></div>
                    </div>

                    <!-- Recent Visit -->
                    <div class="glass p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="ph ph-clock-counter-clockwise mr-2 text-gray-500"></i>
                            Last Visit
                        </h3>
                        <div id="summary-last-visit"></div>
                    </div>
                </div>
            </div>

            <!-- Problems Tab -->
            <div class="tab-panel hidden" data-tab="problems">
                <div class="glass p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Problem List</h3>
                        <button class="btn-primary btn-sm">
                            <i class="ph ph-plus mr-1"></i>
                            Add Problem
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table w-full">
                            <thead>
                                <tr>
                                    <th>ICD-10 Code</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Onset Date</th>
                                    <th>HCC</th>
                                </tr>
                            </thead>
                            <tbody id="problems-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Medications Tab -->
            <div class="tab-panel hidden" data-tab="medications">
                <div class="glass p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Medication List</h3>
                        <button class="btn-primary btn-sm">
                            <i class="ph ph-plus mr-1"></i>
                            Add Medication
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table w-full">
                            <thead>
                                <tr>
                                    <th>Medication</th>
                                    <th>Dosage</th>
                                    <th>Prescriber</th>
                                    <th>Start Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="medications-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Visits Tab -->
            <div class="tab-panel hidden" data-tab="visits">
                <div class="glass p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Visit History</h3>
                        <div class="flex gap-2">
                            <select class="px-3 py-2 border border-gray-300 rounded-lg text-sm" id="visit-filter">
                                <option value="all">All Visits</option>
                                <option value="year">This Year</option>
                                <option value="6months">Past 6 Months</option>
                            </select>
                        </div>
                    </div>
                    <div id="visits-list" class="space-y-4"></div>
                </div>
            </div>

            <!-- Vitals Tab -->
            <div class="tab-panel hidden" data-tab="vitals">
                <div class="glass p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Vital Signs History</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table w-full">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Blood Pressure</th>
                                    <th>Heart Rate</th>
                                    <th>Temperature</th>
                                    <th>Weight</th>
                                    <th>BMI</th>
                                    <th>O2 Sat</th>
                                </tr>
                            </thead>
                            <tbody id="vitals-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Labs Tab -->
            <div class="tab-panel hidden" data-tab="labs">
                <div class="glass p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Laboratory Results</h3>
                    <div id="labs-content"></div>
                </div>
            </div>

            <!-- Preventive Services Tab -->
            <div class="tab-panel hidden" data-tab="preventive">
                <div class="grid grid-cols-1 gap-6">
                    <!-- Cancer Screenings -->
                    <div class="glass p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="ph ph-heartbeat mr-2 text-pink-500"></i>
                            Cancer Screenings
                        </h3>
                        <div id="cancer-screenings-content"></div>
                    </div>

                    <!-- Other Screenings -->
                    <div class="glass p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="ph ph-shield-check mr-2 text-sky-500"></i>
                            Other Screenings
                        </h3>
                        <div id="other-screenings-content"></div>
                    </div>

                    <!-- Immunizations -->
                    <div class="glass p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="ph ph-syringe mr-2 text-green-500"></i>
                            Immunizations
                        </h3>
                        <div id="immunizations-content"></div>
                    </div>
                </div>
            </div>

            <!-- Assessments Tab -->
            <div class="tab-panel hidden" data-tab="assessments">
                <div class="grid grid-cols-1 gap-6">
                    <!-- Depression Screening -->
                    <div class="glass p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="ph ph-brain mr-2 text-purple-500"></i>
                            Depression Screening (PHQ-2/PHQ-9)
                        </h3>
                        <div id="depression-assessment-content"></div>
                    </div>

                    <!-- Fall Risk -->
                    <div class="glass p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="ph ph-warning mr-2 text-yellow-500"></i>
                            Fall Risk Assessment
                        </h3>
                        <div id="fall-risk-content"></div>
                    </div>

                    <!-- Functional Status -->
                    <div class="glass p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="ph ph-user-check mr-2 text-green-500"></i>
                            Functional Status (ADLs/IADLs)
                        </h3>
                        <div id="functional-status-content"></div>
                    </div>

                    <!-- Counseling History -->
                    <div class="glass p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="ph ph-chalkboard-teacher mr-2 text-sky-500"></i>
                            Counseling & Education
                        </h3>
                        <div id="counseling-content"></div>
                    </div>
                </div>
            </div>

            <!-- Surgical History Tab -->
            <div class="tab-panel hidden" data-tab="surgical">
                <div class="glass p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="ph ph-knife mr-2 text-red-500"></i>
                        Surgical History
                    </h3>
                    <div id="surgical-history-content"></div>
                </div>
            </div>

            <!-- Family History Tab -->
            <div class="tab-panel hidden" data-tab="family">
                <div class="glass p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="ph ph-users-three mr-2 text-blue-500"></i>
                        Family History
                    </h3>
                    <div id="family-history-content"></div>
                </div>
            </div>

            <!-- Social History Tab -->
            <div class="tab-panel hidden" data-tab="social">
                <div class="glass p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="ph ph-house mr-2 text-orange-500"></i>
                        Social History
                    </h3>
                    <div id="social-history-content"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.tab-button {
    padding: 1rem 1.5rem;
    font-weight: 500;
    color: #6b7280;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
}

.tab-button:hover {
    color: #0ea5e9;
    background: #f0f9ff;
}

.tab-button.active {
    color: #0ea5e9;
    border-bottom-color: #0ea5e9;
    background: #f0f9ff;
}

.tab-panel {
    animation: fadeIn 0.3s ease-in;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}
</style>

<script type="module">
    import { calculateAge } from '../js/navigation.js';
    import { showToast } from '../js/ui-components.js';

    console.log('üìã Initializing patient chart page...');

    window.initPatientChart = function() {
        console.log('üìÑ Patient Chart page loaded');
        
        // Try to get patient from app state or localStorage
        let patient = window.appState.currentPatient;
        
        if (!patient) {
            // Try loading from localStorage
            const storedPatient = localStorage.getItem('currentPatient');
            if (storedPatient) {
                try {
                    patient = JSON.parse(storedPatient);
                    window.appState.currentPatient = patient;
                    console.log('‚úÖ Loaded patient from localStorage:', patient.name);
                } catch (error) {
                    console.error('Error parsing stored patient:', error);
                }
            }
        }
        
        if (!patient) {
            console.log('‚ö†Ô∏è No patient selected');
            document.getElementById('no-patient-message').classList.remove('hidden');
            document.getElementById('patient-chart-content').classList.add('hidden');
            return;
        }
        
        console.log('‚úÖ Loading chart for patient:', patient.name);
        
        document.getElementById('no-patient-message').classList.add('hidden');
        document.getElementById('patient-chart-content').classList.remove('hidden');
        
        // Load patient data
        loadPatientHeader(patient);
        loadSummaryTab(patient);
        loadProblemsTab(patient);
        loadMedicationsTab(patient);
        loadVisitsTab(patient);
        loadVitalsTab(patient);
        loadLabsTab(patient);
        
        // Setup tab switching
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });
    };

    function loadPatientHeader(patient) {
        document.getElementById('chart-patient-name').textContent = patient.name;
        document.getElementById('chart-mrn').textContent = patient.mrn;
        document.getElementById('chart-dob').textContent = formatDate(patient.dob);
        document.getElementById('chart-age').textContent = calculateAge(patient.dob);
        document.getElementById('chart-gender').textContent = patient.gender;
        
        const allergiesEl = document.getElementById('chart-allergies');
        if (patient.allergies && patient.allergies.length > 0) {
            allergiesEl.innerHTML = patient.allergies.map(a => 
                `<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-700 font-medium">${a}</span>`
            ).join(' ');
        } else {
            allergiesEl.innerHTML = '<span class="text-green-600 font-medium">NKDA</span>';
        }
    }

    function loadSummaryTab(patient) {
        // Problems
        const problemsEl = document.getElementById('summary-problems');
        problemsEl.innerHTML = patient.problems.slice(0, 5).map(p => `
            <div class="flex items-start gap-2 p-2 bg-red-50 rounded">
                <i class="ph ph-dot text-red-500 text-xl mt-0.5"></i>
                <div class="flex-1">
                    <div class="font-medium text-sm">${p.code} - ${p.description}</div>
                    <div class="text-xs text-gray-600">Since ${formatDate(p.onset)}</div>
                </div>
            </div>
        `).join('');

        // Medications
        const medsEl = document.getElementById('summary-medications');
        medsEl.innerHTML = patient.medications.slice(0, 5).map(m => `
            <div class="flex items-start gap-2 p-2 bg-sky-50 rounded">
                <i class="ph ph-pill text-sky-500 text-xl mt-0.5"></i>
                <div class="flex-1">
                    <div class="font-medium text-sm">${m.name}</div>
                    <div class="text-xs text-gray-600">${m.dosage}</div>
                </div>
            </div>
        `).join('');

        // Recent Vitals
        if (patient.vitals && patient.vitals.length > 0) {
            const latest = patient.vitals[0];
            document.getElementById('summary-vitals').innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div><span class="text-gray-600">BP:</span> <strong>${latest.bp}</strong></div>
                    <div><span class="text-gray-600">HR:</span> <strong>${latest.hr} bpm</strong></div>
                    <div><span class="text-gray-600">Temp:</span> <strong>${latest.temp}¬∞F</strong></div>
                    <div><span class="text-gray-600">Weight:</span> <strong>${latest.weight} lbs</strong></div>
                    <div><span class="text-gray-600">BMI:</span> <strong>${latest.bmi}</strong></div>
                    ${latest.o2sat ? `<div><span class="text-gray-600">O2:</span> <strong>${latest.o2sat}%</strong></div>` : ''}
                </div>
                <div class="text-xs text-gray-500 mt-2">Recorded: ${formatDate(latest.date)}</div>
            `;
        }

        // Last Visit
        if (patient.visits && patient.visits.length > 0) {
            const lastVisit = patient.visits[0];
            document.getElementById('summary-last-visit').innerHTML = `
                <div class="space-y-2">
                    <div><span class="text-gray-600">Date:</span> <strong>${formatDate(lastVisit.date)}</strong></div>
                    <div><span class="text-gray-600">Type:</span> <strong>${lastVisit.type}</strong></div>
                    <div><span class="text-gray-600">Provider:</span> <strong>${lastVisit.provider}</strong></div>
                    <div class="pt-2 border-t">
                        <div class="text-sm font-medium text-gray-700 mb-1">Chief Complaint:</div>
                        <div class="text-sm text-gray-600">${lastVisit.chiefComplaint}</div>
                    </div>
                </div>
            `;
        }
    }

    function loadProblemsTab(patient) {
        const tbody = document.getElementById('problems-table-body');
        tbody.innerHTML = patient.problems.map(p => `
            <tr>
                <td class="font-mono font-medium">${p.code}</td>
                <td>${p.description}</td>
                <td><span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">${p.status}</span></td>
                <td>${formatDate(p.onset)}</td>
                <td>${p.hcc || '<span class="text-gray-400">N/A</span>'}</td>
            </tr>
        `).join('');
    }

    function loadMedicationsTab(patient) {
        const tbody = document.getElementById('medications-table-body');
        tbody.innerHTML = patient.medications.map(m => `
            <tr>
                <td class="font-medium">${m.name}</td>
                <td>${m.dosage}</td>
                <td>${m.prescriber}</td>
                <td>${formatDate(m.startDate)}</td>
                <td>
                    <button class="text-sky-500 hover:text-sky-700 text-sm">
                        <i class="ph ph-pencil-simple mr-1"></i>Edit
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function loadVisitsTab(patient) {
        const container = document.getElementById('visits-list');
        
        // Combine regular visits with completed guided visits
        const allVisits = [...(patient.visits || [])];
        
        // Check localStorage for any saved guided visits
        const savedVisits = JSON.parse(localStorage.getItem('patientVisits_' + patient.id) || '[]');
        allVisits.push(...savedVisits);
        
        // Sort by date descending
        allVisits.sort((a, b) => new Date(b.date || b.completedTime) - new Date(a.date || b.completedTime));
        
        if (allVisits.length === 0) {
            container.innerHTML = `
                <div class="glass p-8 text-center">
                    <i class="ph ph-clock-counter-clockwise text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-600 mb-4">No visit history available</p>
                    <button onclick="window.location.hash='guided-visit'" class="btn-primary">
                        <i class="ph ph-clipboard-text mr-2"></i>
                        Start New Guided Visit
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = allVisits.map(v => {
            // Determine if this is a guided visit or legacy visit
            const isGuidedVisit = v.visitType && v.completedSections;
            const visitDate = v.date || v.completedTime || v.startTime;
            const visitType = v.visitType || v.type || 'Office Visit';
            
            if (isGuidedVisit) {
                // Enhanced display for guided visits with protocol info
                return `
                    <div class="glass p-4 border-l-4 border-green-500">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <div class="flex items-center gap-2">
                                    <div class="font-bold text-gray-800">${formatDate(visitDate)}</div>
                                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">
                                        <i class="ph ph-check-circle"></i> Protocol-Guided
                                    </span>
                                </div>
                                <div class="text-sm text-gray-600">${v.provider || 'Dr. Pompee'}</div>
                            </div>
                            <span class="px-3 py-1 text-xs rounded-full bg-sky-100 text-sky-700 font-semibold">${visitType.toUpperCase()}</span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="text-sm font-medium text-gray-700">Protocol Completion:</div>
                                <div class="flex-grow bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: ${calculateCompletionPercent(v)}%"></div>
                                </div>
                                <span class="text-sm font-bold text-green-600">${calculateCompletionPercent(v)}%</span>
                            </div>
                            <div class="text-xs text-gray-600">
                                <i class="ph ph-check-square"></i> ${v.completedSections?.length || 0} sections completed
                            </div>
                        </div>
                        
                        <div class="space-y-2 text-sm">
                            ${v.chiefComplaint ? `<div><strong>Chief Complaint:</strong> ${v.chiefComplaint}</div>` : ''}
                            ${v.hpi ? `<div><strong>HPI:</strong> ${v.hpi}</div>` : ''}
                            ${v.assessment ? `<div><strong>Assessment:</strong> ${v.assessment}</div>` : ''}
                            ${v.plan ? `<div><strong>Plan:</strong> ${v.plan}</div>` : ''}
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <button onclick="viewVisitDetails('${v.visitId || v.startTime}')" class="text-sky-600 hover:text-sky-700 text-sm font-medium">
                                <i class="ph ph-eye mr-1"></i> View Full Documentation
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Legacy visit display
                return `
                    <div class="glass p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <div class="font-bold text-gray-800">${formatDate(visitDate)}</div>
                                <div class="text-sm text-gray-600">${v.provider || 'Dr. Pompee'}</div>
                            </div>
                            <span class="px-3 py-1 text-xs rounded-full bg-sky-100 text-sky-700">${visitType}</span>
                        </div>
                        <div class="space-y-2 text-sm">
                            ${v.chiefComplaint ? `<div><strong>Chief Complaint:</strong> ${v.chiefComplaint}</div>` : ''}
                            ${v.hpi ? `<div><strong>HPI:</strong> ${v.hpi}</div>` : ''}
                            ${v.assessment ? `<div><strong>Assessment:</strong> ${v.assessment}</div>` : ''}
                            ${v.plan ? `<div><strong>Plan:</strong> ${v.plan}</div>` : ''}
                        </div>
                    </div>
                `;
            }
        }).join('');
    }
    
    function calculateCompletionPercent(visit) {
        if (!visit.completedSections || !visit.visitType) return 0;
        // Import visit templates to get total required sections
        // For now, estimate based on completed sections (typically 8-13 sections per visit)
        const estimatedTotal = 10;
        return Math.min(100, Math.round((visit.completedSections.length / estimatedTotal) * 100));
    }
    
    window.viewVisitDetails = function(visitId) {
        // TODO: Create modal or separate page to view full visit documentation
        showToast('Visit detail viewer coming soon', 'info');
    };

    function loadVitalsTab(patient) {
        const tbody = document.getElementById('vitals-table-body');
        tbody.innerHTML = patient.vitals.map(v => `
            <tr>
                <td>${formatDate(v.date)}</td>
                <td>${v.bp}</td>
                <td>${v.hr} bpm</td>
                <td>${v.temp}¬∞F</td>
                <td>${v.weight} lbs</td>
                <td>${v.bmi}</td>
                <td>${v.o2sat ? v.o2sat + '%' : '<span class="text-gray-400">N/A</span>'}</td>
            </tr>
        `).join('');
    }

    function loadLabsTab(patient) {
        const container = document.getElementById('labs-content');
        
        if (!patient.labs || patient.labs.length === 0) {
            container.innerHTML = '<p class="text-gray-500">No laboratory results available.</p>';
            return;
        }
        
        container.innerHTML = patient.labs.map(lab => `
            <div class="mb-6">
                <div class="font-bold text-gray-800 mb-3">${formatDate(lab.date)}</div>
                <table class="data-table w-full">
                    <thead>
                        <tr>
                            <th>Test</th>
                            <th>Value</th>
                            <th>Unit</th>
                            <th>Normal Range</th>
                            <th>Flag</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${lab.tests.map(test => `
                            <tr>
                                <td class="font-medium">${test.name}</td>
                                <td>${test.value}</td>
                                <td>${test.unit}</td>
                                <td>${test.normal}</td>
                                <td>
                                    ${test.flag ? 
                                        `<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-700">${test.flag}</span>` 
                                        : '<span class="text-green-600">Normal</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `).join('');
    }

    function loadPreventiveTab(patient) {
        // Cancer Screenings
        const cancerContainer = document.getElementById('cancer-screenings-content');
        const preventive = patient.preventiveServices || {};
        const screenings = preventive.cancerScreenings || {};
        
        const statusBadge = (status) => {
            const badges = {
                'current': '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">‚úì Current</span>',
                'overdue': '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-700">‚ö† Overdue</span>',
                'due-soon': '<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">‚è∞ Due Soon</span>',
                'n/a': '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700">N/A</span>'
            };
            return badges[status] || badges['n/a'];
        };

        cancerContainer.innerHTML = `
            <table class="data-table w-full">
                <thead><tr><th>Screening</th><th>Last Done</th><th>Due Date</th><th>Status</th></tr></thead>
                <tbody>
                    <tr><td>Mammogram</td><td>${screenings.mammogram?.lastDate || 'Never'}</td>
                        <td>${screenings.mammogram?.dueDate || '-'}</td>
                        <td>${statusBadge(screenings.mammogram?.status)}</td></tr>
                    <tr><td>Colonoscopy</td><td>${screenings.colonoscopy?.lastDate || 'Never'}</td>
                        <td>${screenings.colonoscopy?.dueDate || '-'}</td>
                        <td>${statusBadge(screenings.colonoscopy?.status)}</td></tr>
                    <tr><td>Pap Smear</td><td>${screenings.papSmear?.lastDate || 'Never'}</td>
                        <td>${screenings.papSmear?.dueDate || '-'}</td>
                        <td>${statusBadge(screenings.papSmear?.status)}</td></tr>
                    <tr><td>PSA</td><td>${screenings.psa?.lastDate || 'Never'}</td>
                        <td>${screenings.psa?.dueDate || '-'}</td>
                        <td>${statusBadge(screenings.psa?.status)}</td></tr>
                </tbody>
            </table>
        `;

        // Other Screenings
        const otherContainer = document.getElementById('other-screenings-content');
        const other = preventive.otherScreenings || {};
        otherContainer.innerHTML = `
            <table class="data-table w-full">
                <thead><tr><th>Screening</th><th>Last Done</th><th>Due Date</th><th>Status</th></tr></thead>
                <tbody>
                    <tr><td>Bone Density</td><td>${other.boneDensity?.lastDate || 'Never'}</td>
                        <td>${other.boneDensity?.dueDate || '-'}</td>
                        <td>${statusBadge(other.boneDensity?.status)}</td></tr>
                    <tr><td>Diabetic Eye Exam</td><td>${other.diabeticEyeExam?.lastDate || 'Never'}</td>
                        <td>${other.diabeticEyeExam?.dueDate || '-'}</td>
                        <td>${statusBadge(other.diabeticEyeExam?.status)}</td></tr>
                    <tr><td>Diabetic Foot Exam</td><td>${other.diabeticFootExam?.lastDate || 'Never'}</td>
                        <td>${other.diabeticFootExam?.dueDate || '-'}</td>
                        <td>${statusBadge(other.diabeticFootExam?.status)}</td></tr>
                    <tr><td>Dental Exam</td><td>${other.dentalExam?.lastDate || 'Never'}</td>
                        <td>${other.dentalExam?.dueDate || '-'}</td>
                        <td>${statusBadge(other.dentalExam?.status)}</td></tr>
                </tbody>
            </table>
        `;

        // Immunizations
        const immContainer = document.getElementById('immunizations-content');
        const imm = preventive.immunizations || {};
        immContainer.innerHTML = `
            <table class="data-table w-full">
                <thead><tr><th>Vaccine</th><th>Date Given</th><th>Due Date</th><th>Status</th></tr></thead>
                <tbody>
                    <tr><td>Influenza</td><td>${imm.influenza?.date || 'Never'}</td>
                        <td>${imm.influenza?.dueDate || '-'}</td>
                        <td>${statusBadge(imm.influenza?.status)}</td></tr>
                    <tr><td>Pneumococcal</td><td>${imm.pneumococcal?.date || 'Never'}</td>
                        <td>${imm.pneumococcal?.dueDate || '-'}</td>
                        <td>${statusBadge(imm.pneumococcal?.status)}</td></tr>
                    <tr><td>Shingles</td><td>${imm.shingles?.date || 'Never'}</td>
                        <td>${imm.shingles?.dueDate || '-'}</td>
                        <td>${statusBadge(imm.shingles?.status)}</td></tr>
                    <tr><td>COVID-19</td><td>${imm.covid?.date || 'Never'}</td>
                        <td>${imm.covid?.dueDate || '-'}</td>
                        <td>${statusBadge(imm.covid?.status)}</td></tr>
                    <tr><td>Tdap</td><td>${imm.tdap?.date || 'Never'}</td>
                        <td>${imm.tdap?.dueDate || '-'}</td>
                        <td>${statusBadge(imm.tdap?.status)}</td></tr>
                    <tr><td>Hepatitis B</td><td>${imm.hepatitisB?.date || 'Never'}</td>
                        <td>${imm.hepatitisB?.dueDate || '-'}</td>
                        <td>${statusBadge(imm.hepatitisB?.status)}</td></tr>
                </tbody>
            </table>
        `;
    }

    function loadAssessmentsTab(patient) {
        const assessments = patient.assessments || {};

        // Depression
        const depressionContainer = document.getElementById('depression-assessment-content');
        const depression = assessments.depression || {};
        depressionContainer.innerHTML = `
            <div class="space-y-4">
                ${depression.phq2 ? `
                    <div class="p-4 bg-purple-50 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <strong>PHQ-2 Screening</strong>
                            <span class="text-2xl font-bold ${depression.phq2.score >= 3 ? 'text-red-600' : 'text-green-600'}">
                                ${depression.phq2.score}/6
                            </span>
                        </div>
                        <div class="text-sm text-gray-700">
                            ${depression.phq2.score >= 3 ? '‚ö† Positive screen (‚â•3)' : '‚úì Negative screen (<3)'}
                        </div>
                    </div>
                ` : '<p class="text-gray-500">PHQ-2 not completed</p>'}
                
                ${depression.phq9 ? `
                    <div class="p-4 bg-purple-50 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <strong>PHQ-9 Depression Assessment</strong>
                            <span class="text-2xl font-bold ${depression.phq9.score >= 10 ? 'text-red-600' : depression.phq9.score >= 5 ? 'text-yellow-600' : 'text-green-600'}">
                                ${depression.phq9.score}/27
                            </span>
                        </div>
                        <div class="text-sm text-gray-700 mb-2">
                            <strong>Severity:</strong> 
                            ${depression.phq9.score >= 20 ? 'Severe' : depression.phq9.score >= 15 ? 'Moderately Severe' : depression.phq9.score >= 10 ? 'Moderate' : depression.phq9.score >= 5 ? 'Mild' : 'Minimal'}
                        </div>
                        ${depression.phq9.notes ? `<div class="text-sm text-gray-700"><strong>Notes:</strong> ${depression.phq9.notes}</div>` : ''}
                    </div>
                ` : ''}
            </div>
        `;

        // Fall Risk
        const fallContainer = document.getElementById('fall-risk-content');
        const fall = assessments.fallRisk || {};
        fallContainer.innerHTML = `
            <div class="space-y-3">
                <div class="grid grid-cols-3 gap-4">
                    <div class="p-3 bg-yellow-50 rounded-lg text-center">
                        <div class="text-sm text-gray-600 mb-1">History of Falls</div>
                        <div class="text-xl font-bold">${fall.historyOfFalls ? '‚úì Yes' : '‚úó No'}</div>
                    </div>
                    <div class="p-3 bg-yellow-50 rounded-lg text-center">
                        <div class="text-sm text-gray-600 mb-1">Gait Problems</div>
                        <div class="text-xl font-bold">${fall.gaitBalanceProblems ? '‚úì Yes' : '‚úó No'}</div>
                    </div>
                    <div class="p-3 ${fall.highRiskFlag ? 'bg-red-100' : 'bg-green-100'} rounded-lg text-center">
                        <div class="text-sm text-gray-600 mb-1">Risk Level</div>
                        <div class="text-xl font-bold ${fall.highRiskFlag ? 'text-red-700' : 'text-green-700'}">
                            ${fall.highRiskFlag ? '‚ö† HIGH' : '‚úì Low'}
                        </div>
                    </div>
                </div>
                ${fall.lastFallDate ? `<div class="text-sm"><strong>Last Fall:</strong> ${formatDate(fall.lastFallDate)}</div>` : ''}
                ${fall.interventions ? `<div class="p-3 bg-sky-50 rounded-lg"><strong>Interventions:</strong><div class="mt-1 text-sm">${fall.interventions}</div></div>` : ''}
            </div>
        `;

        // Functional Status
        const functionalContainer = document.getElementById('functional-status-content');
        const functional = assessments.functionalStatus || {};
        const adls = functional.adls || {};
        const iadls = functional.iadls || {};
        
        const statusIcon = (status) => {
            if (status === 'independent') return '<span class="text-green-600">‚úì Independent</span>';
            if (status === 'needs-assistance') return '<span class="text-yellow-600">‚ö† Needs Assistance</span>';
            return '<span class="text-red-600">‚úó Dependent</span>';
        };

        functionalContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-bold mb-3">Activities of Daily Living (ADLs)</h4>
                    <table class="data-table w-full text-sm">
                        <tbody>
                            <tr><td>Bathing</td><td>${statusIcon(adls.bathing)}</td></tr>
                            <tr><td>Dressing</td><td>${statusIcon(adls.dressing)}</td></tr>
                            <tr><td>Toileting</td><td>${statusIcon(adls.toileting)}</td></tr>
                            <tr><td>Transferring</td><td>${statusIcon(adls.transferring)}</td></tr>
                            <tr><td>Eating</td><td>${statusIcon(adls.eating)}</td></tr>
                        </tbody>
                    </table>
                </div>
                <div>
                    <h4 class="font-bold mb-3">Instrumental ADLs (IADLs)</h4>
                    <table class="data-table w-full text-sm">
                        <tbody>
                            <tr><td>Medications</td><td>${statusIcon(iadls.medications)}</td></tr>
                            <tr><td>Finances</td><td>${statusIcon(iadls.finances)}</td></tr>
                            <tr><td>Meal Preparation</td><td>${statusIcon(iadls.meals)}</td></tr>
                            <tr><td>Housekeeping</td><td>${statusIcon(iadls.housekeeping)}</td></tr>
                            <tr><td>Transportation</td><td>${statusIcon(iadls.transportation)}</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            ${functional.notes ? `<div class="mt-4 p-3 bg-sky-50 rounded-lg text-sm"><strong>Notes:</strong> ${functional.notes}</div>` : ''}
        `;

        // Counseling
        const counselingContainer = document.getElementById('counseling-content');
        const counseling = assessments.counseling || {};
        const topics = counseling.topics || [];
        
        counselingContainer.innerHTML = `
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                ${topics.map(topic => `
                    <div class="px-3 py-2 bg-sky-50 border border-sky-200 rounded-lg text-sm">
                        <i class="ph ph-check-circle text-green-600 mr-2"></i>
                        ${topic.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                    </div>
                `).join('') || '<p class="text-gray-500 col-span-3">No counseling documented</p>'}
            </div>
            ${counseling.notes ? `<div class="mt-4 p-3 bg-sky-50 rounded-lg text-sm"><strong>Notes:</strong> ${counseling.notes}</div>` : ''}
        `;
    }

    function loadSurgicalTab(patient) {
        const container = document.getElementById('surgical-history-content');
        const surgical = patient.surgicalHistory || [];

        if (surgical.length === 0) {
            container.innerHTML = '<p class="text-gray-500">No surgical history recorded.</p>';
            return;
        }

        container.innerHTML = `
            <table class="data-table w-full">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Procedure</th>
                        <th>Hospital</th>
                        <th>Surgeon</th>
                        <th>Complications</th>
                    </tr>
                </thead>
                <tbody>
                    ${surgical.map(s => `
                        <tr>
                            <td>${s.date}</td>
                            <td class="font-medium">${s.procedure}</td>
                            <td>${s.hospital || '-'}</td>
                            <td>${s.surgeon || '-'}</td>
                            <td>${s.complications || '<span class="text-green-600">None</span>'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    function loadFamilyTab(patient) {
        const container = document.getElementById('family-history-content');
        const family = patient.familyHistory || [];

        if (family.length === 0) {
            container.innerHTML = '<p class="text-gray-500">No family history recorded.</p>';
            return;
        }

        container.innerHTML = `
            <table class="data-table w-full">
                <thead>
                    <tr>
                        <th>Relation</th>
                        <th>Condition</th>
                        <th>Age of Onset</th>
                        <th>Additional Info</th>
                    </tr>
                </thead>
                <tbody>
                    ${family.map(f => `
                        <tr>
                            <td class="font-medium">${f.relation}</td>
                            <td>${f.condition}</td>
                            <td>${f.ageOfOnset ? 'Age ' + f.ageOfOnset : '-'}</td>
                            <td>${f.additionalInfo || '-'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    function loadSocialTab(patient) {
        const container = document.getElementById('social-history-content');
        const social = patient.socialHistory || {};

        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Tobacco Use -->
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold mb-2 flex items-center">
                        <i class="ph ph-cigarette mr-2 text-red-500"></i>
                        Tobacco Use
                    </h4>
                    <div class="text-sm">
                        <div><strong>Status:</strong> ${social.smoking || 'Not documented'}</div>
                        ${social.smokingHistory ? `<div class="mt-1 text-gray-600">${social.smokingHistory}</div>` : ''}
                    </div>
                </div>

                <!-- Alcohol Use -->
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold mb-2 flex items-center">
                        <i class="ph ph-wine mr-2 text-purple-500"></i>
                        Alcohol Use
                    </h4>
                    <div class="text-sm">
                        <div><strong>Status:</strong> ${social.alcohol || 'Not documented'}</div>
                        ${social.alcoholDetails ? `<div class="mt-1 text-gray-600">${social.alcoholDetails}</div>` : ''}
                    </div>
                </div>

                <!-- Drug Use -->
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold mb-2 flex items-center">
                        <i class="ph ph-syringe mr-2 text-orange-500"></i>
                        Substance Use
                    </h4>
                    <div class="text-sm">
                        <div><strong>Status:</strong> ${social.drugs || 'Not documented'}</div>
                        ${social.drugDetails ? `<div class="mt-1 text-gray-600">${social.drugDetails}</div>` : ''}
                    </div>
                </div>

                <!-- Exercise -->
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold mb-2 flex items-center">
                        <i class="ph ph-person-simple-run mr-2 text-green-500"></i>
                        Physical Activity
                    </h4>
                    <div class="text-sm">
                        ${social.exercise || 'Not documented'}
                    </div>
                </div>

                <!-- Occupation -->
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold mb-2 flex items-center">
                        <i class="ph ph-briefcase mr-2 text-blue-500"></i>
                        Occupation
                    </h4>
                    <div class="text-sm">
                        ${social.occupation || 'Not documented'}
                    </div>
                </div>

                <!-- Living Situation -->
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold mb-2 flex items-center">
                        <i class="ph ph-house mr-2 text-sky-500"></i>
                        Living Situation
                    </h4>
                    <div class="text-sm">
                        ${social.livingSituation || 'Not documented'}
                    </div>
                </div>
            </div>
        `;
    }

    function switchTab(tabName) {
        // Update buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // Update panels
        document.querySelectorAll('.tab-panel').forEach(panel => {
            panel.classList.add('hidden');
        });
        document.querySelector(`.tab-panel[data-tab="${tabName}"]`).classList.remove('hidden');
        
        // Load tab-specific data
        const patient = window.appState.currentPatient;
        if (tabName === 'preventive') loadPreventiveTab(patient);
        if (tabName === 'assessments') loadAssessmentsTab(patient);
        if (tabName === 'surgical') loadSurgicalTab(patient);
        if (tabName === 'family') loadFamilyTab(patient);
        if (tabName === 'social') loadSocialTab(patient);
        
        console.log(`üìë Switched to ${tabName} tab`);
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
    }

    window.printChart = function() {
        showToast('Print functionality coming soon!', 'info');
    };

    // Auto-initialize
    if (document.readyState === 'complete') {
        window.initPatientChart();
    }
</script>
